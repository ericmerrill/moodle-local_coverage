language: php

sudo: false

cache:
  directories:
    - $HOME/.composer/cache

php:
 - 5.6
# - 7.0

env:
 matrix:
  - DB=pgsql MOODLE_BRANCH=MOODLE_30_STABLE


before_install:
#  - export XDEBUGSO="$(cat ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini | grep xdebug)"
#  - echo $XDEBUGSO
#  - ls -R ~/.phpenv/versions/$(phpenv version-name)/etc
  - phpenv config-rm xdebug.ini
  - cd ../..
  - composer selfupdate
  - composer create-project -n --no-dev moodlerooms/moodle-plugin-ci ci ^1
  - composer create-project -n satooshi/php-coveralls coveralls dev-master
  - export PATH="$(cd ci/bin; pwd):$(cd ci/vendor/bin; pwd):$PATH"

install:
  - moodle-plugin-ci install

script:
#  - moodle-plugin-ci codechecker
#  - moodle-plugin-ci validate
  - mkdir -p build/logs
#  - phpenv config-add xdebug.ini
  - sed "/<\/phpunit>/  s|</phpunit>|<logging><log type=\"coverage-clover\" target=\"$(pwd)/build/logs/clover.xml\"/></logging></phpunit>| " moodle/phpunit.xml > moodle/phpunit2.xml
  - mv moodle/phpunit2.xml moodle/phpunit.xml
  - sed '/<testsuites>/  s|<testsuites>|<filter><whitelist processUncoveredFilesFromWhitelist="true"><directory suffix=".php">local/coverage</directory></whitelist></filter><testcases>| ' moodle/phpunit.xml > moodle/phpunit2.xml
#  - sed '/<testsuite name="local_coverage_testsuite">/  s|<testsuite name="local_coverage_testsuite">|<testsuite name="local_coverage_testsuite"><filter><whitelist processUncoveredFilesFromWhitelist="true"><directory suffix=".php">local/coverage</directory></whitelist></filter>| ' moodle/phpunit.xml > moodle/phpunit2.xml
#  - sed '/<testsuite name="local_coverage_testsuite">/  s|<testsuite name="local_coverage_testsuite">|<testsuite name="local_coverage_testsuite"><filter><whitelist processUncoveredFilesFromWhitelist="true"><file>local/coverage/lib.php</file></whitelist></filter>| ' moodle/phpunit.xml > moodle/phpunit2.xml
  - mv moodle/phpunit2.xml moodle/phpunit.xml
  - cat moodle/phpunit.xml
  - phpenv config-add /home/travis/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini
  - moodle-plugin-ci phpunit
  
after_success:
  - ls
  - ls build/logs
  - php coveralls/bin/coveralls -v

